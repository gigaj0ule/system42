#include "./crc.hpp"

// =========================================================================
// CRC32 tables here are ONLY for one polynomial...
// CANONICAL_CRC32_POLYNOMIAL = 0xc9d204f5

constexpr uint32_t crc32_table_le[256] = {0, 2190457617, 2528870345, 339002584, 3201496697, 1012747624, 678005168, 2867212961, 3993101593, 1821269512, 2025495248, 4197786049, 1356010336, 3529287793, 3328732329, 1156044728, 1336394713, 3441981640, 3642539024, 1536362241, 4050990496, 1945800369, 1741572713, 3846304120, 2712020672, 589929937, 924670217, 3046302232, 527749305, 2650500008, 2312089456, 188748897, 2672789426, 499137699, 167049339, 2340111210, 563966411, 2735917786, 3072724482, 900314387, 1900962475, 4089567674, 3891600738, 1702536819, 3483145426, 1293103043, 1495788315, 3685240842, 3504882795, 1382547322, 1179859874, 3302785203, 1849340434, 3971287299, 4169256411, 2047768266, 1055498610, 3160808035, 2824003259, 719152554, 2151372555, 45411354, 377497794, 2484048851, 2906326671, 800374174, 998275398, 3104817751, 334098678, 2439400423, 2236780351, 131937326, 1127932822, 3249887367, 3582041183, 1460545358, 4259845615, 2137501438, 1800628774, 3923562807, 3801924950, 1611890247, 1948760735, 4138205582, 1548628783, 3737225278, 3405073638, 1216018423, 211624015, 2383584094, 2586206086, 413787287, 2991576630, 817917223, 620014079, 2793083630, 846496061, 2969254444, 2765094644, 641746405, 2359719748, 237620309, 438110349, 2559751068, 3698680868, 1593499445, 1255021549, 3359744252, 1655149149, 3760728396, 4095536532, 1989367429, 2110997220, 4284283381, 3949477165, 1776780860, 3271668893, 1099829132, 1438305108, 3610603589, 2480056317, 291314924, 90822708, 2280022821, 754995588, 2945444501, 3149606477, 959747420, 3385984245, 1264435172, 1600748348, 3722887213, 1996550796, 4119808413, 3787164997, 1664366164, 668197356, 2774293245, 2976423461, 870786356, 2566985621, 462335108, 263874652, 2369114957, 2255865644, 83524669, 281983205, 2453734388, 950481237, 3123219012, 2921090716, 747894157, 1752441397, 3942357284, 4275002876, 2084628205, 3601257548, 1412001629, 1075686277, 3264352404, 1453163335, 3557963862, 3223780494, 1118390175, 3897521470, 1791020591, 2129922807, 4235964902, 3097257566, 974380367, 774314391, 2896732806, 105812007, 2227252022, 2432036846, 310007039, 423248030, 2612394895, 2407612247, 219055174, 2817046247, 627510774, 827574574, 3017568831, 4147881351, 1974738582, 1635834446, 3809435999, 1240028158, 3412519151, 3746704439, 1574803238, 1692992122, 3865491819, 4065492403, 1893582498, 3661362179, 1488211730, 1283492810, 3457102043, 2330519395, 140991602, 475240618, 2665227195, 876220698, 3065358859, 2726391507, 537843138, 726581667, 2848029362, 3186998890, 1064961403, 2510043098, 387157195, 52906003, 2175333122, 3310298298, 1203806123, 1408523123, 3514556514, 2073940675, 4178733522, 3978734858, 1873352219, 4221994440, 2032746201, 1830681089, 4019339536, 1165259697, 3355166880, 3553561720, 1363195753, 363290833, 2536037312, 2199658264, 26453001, 2876610216, 704261561, 1036970337, 3208729200, 3019982353, 915340544, 582629848, 2687861449, 181645416, 2287733625, 2624114593, 518485168, 1509991176, 3633256473, 3434863809, 1312057296, 3838989681, 1717431904, 1919494840, 4041642409};
constexpr uint32_t crc32_table_be[256] = {0, 3385984245, 1517686047, 2477001194, 3035372094, 2101223115, 4003075873, 659035092, 2685022345, 1775776892, 4202446230, 867055971, 350628535, 3711184450, 1318070184, 2269258589, 2311480807, 1075077394, 3551553784, 442657805, 1026195417, 4109925164, 1734111942, 2928571955, 701257070, 3760083355, 1941592177, 3127401604, 2636140368, 1425165221, 3344319055, 243549882, 3663646523, 327994318, 2150154788, 1241171665, 1857213701, 2808140272, 885315610, 4246133999, 2052390834, 3011967815, 539161261, 3924883032, 3468223884, 124445049, 2496587923, 1562176614, 1402514140, 2588585513, 166635459, 3225199414, 3883184354, 782677015, 3171073533, 1959835912, 4086471253, 977313440, 2850330442, 1614189503, 1199472747, 2393670814, 487099764, 3571091841, 2104466051, 3032325750, 655988636, 4006318953, 3380838589, 5342280, 2482343330, 1512540503, 3714427402, 347582207, 2266212117, 1321313248, 1770631220, 2690364609, 872398123, 4197300702, 4104781668, 1031535505, 2933912187, 1728968334, 1078322522, 2308432303, 439609413, 3554798768, 1420021741, 2641480472, 248890098, 3339175431, 3763328467, 698208550, 3124353228, 1944837177, 2805028280, 1860391245, 4249311399, 882203730, 333270918, 3658435443, 1235960473, 2155431532, 121333041, 3471401412, 1565354030, 2493476059, 3017244431, 2047179770, 3919671824, 544437989, 787951711, 3877975210, 1954626880, 3176348085, 2585471585, 1405693588, 3228379006, 163521419, 2398945494, 1194263587, 3565882825, 492374332, 974199528, 4089650717, 1617369079, 2847216386, 4208932102, 856502771, 2695444505, 1769684204, 1311977272, 2279680973, 340075047, 3717670610, 1523910031, 2466709882, 10684560, 3379629157, 3996721073, 669719364, 3025081006, 2107446875, 1931038945, 3133887508, 695164414, 3770505483, 3354741471, 237456938, 2642626496, 1414611765, 3541262440, 448881821, 2305125751, 1085761922, 1744796246, 2922217123, 1032419145, 4099634108, 545389117, 3914596040, 2063071010, 3005608919, 2490228739, 1572857078, 3457936668, 130673129, 2156645044, 1230622273, 3674064811, 321897310, 879218826, 4256552063, 1846664597, 2814630240, 2840043482, 1620417327, 4080112325, 987993648, 497780196, 3564732689, 1205700859, 2383383566, 156086099, 3231689638, 1396417100, 2599003833, 3181491565, 1953739160, 3889674354, 772127879, 2276503429, 1315089264, 3720782490, 336897647, 861713851, 4203655502, 1764407460, 2700655697, 666541836, 3999833081, 2110558739, 3021903590, 2471920946, 1518633415, 3374352429, 15895768, 242666082, 3349466775, 1409337213, 2647835528, 3130708060, 1934152873, 3773619523, 691984822, 2927426283, 1739521566, 4094359540, 1037628161, 445702357, 3544376352, 1088875978, 2301946175, 1575903422, 2486985803, 127430049, 3460983124, 3909253760, 550534773, 3010754463, 2057728874, 4259598391, 875975874, 2811387176, 1849711069, 1225280009, 2161790716, 327042838, 3668722659, 3559392601, 502923692, 2388527174, 1200360627, 1623465831, 2836798354, 984748664, 4083160717, 1948399056, 3186635045, 777271503, 3884334138, 3234738158, 152840987, 2595758833, 1399465476};


// =========================================================================
// Creates lookup tables for fast CRC functions at runtime
// TODO: this uses up too much ram to be useful, so we hard-code the tables
// now...
bool crc_tables_calculated = false;

template<uint32_t, unsigned POLYNOMIAL>
void init_crc32_tables(){

    for(uint32_t i = 0; i < 256; i++) {
        //Big endian table     
        crc32_table_be[i] = calc_crc<uint32_t, POLYNOMIAL>(0, i, true);

        // Little endian table
        crc32_table_le[i] = calc_crc<uint32_t, POLYNOMIAL>(0, i, false);
    }

    crc_tables_calculated = true;
}


// =========================================================================
// Calculates a CRC32 value from a running stream using L.U.T.
uint32_t calc_crc32_fast(uint32_t remainder, uint8_t value, bool endian = false) {

    if (endian == true) {
        // XOR-in next input byte into MSB of crc and get this MSB, that's our new intermediate divident 
        uint8_t pos = ((remainder ^ (value << 24)) >> 24) & 0xFF;

        // Shift out the MSB used for division per lookuptable and XOR with the remainder
        remainder = ((remainder << 8) ^ crc32_table_be[pos]) & 0xFFFFFFFF;
    }
    else {
        // For little endian, do the same thing but reversed 
        uint8_t pos = (remainder ^ value) & 0xFF;
        
        remainder = ((remainder >> 8) ^ crc32_table_le[pos]) & 0xFFFFFFFF;
    }

    return remainder;
}
